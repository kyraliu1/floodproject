---
title: "ESP 106 Final Project"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# knitr::opts_knit$set(root.dir= '/Users/sunga/Documents/GitHub/floodproject') # sung wd
# knitr::opts_knit$set(root.dir = "/Volumes/KYRADRIVE/floodproject") # kyra mac wd
# knitr::opts_knit$set(root.dir = "F:/floodproject") # kyra windows wd

library(terra)
library(ggplot2)
library(geodata)
library(wesanderson)

```
Creating a function that allows you to put in any county in California and get land use data and national flood hazard layer for that county and save as rds. This allows us to process data for multiple counties much more efficiently. Also, it allows us to save a much smaller (cropped) data set for an individual county rather than having to access both statewide data sets all at once.  
The function takes in a string of the county's name. If the county exists in California (case insensitive), then it crops both data sets to the specified county and saves each subset data as a RDS. If the county, as inputted, is not in California, the function breaks and returns an error which states that the county does not exist in California.  
The flood data we have is from FEMA's national flood hazard layer. The land use data is from the California natural resources agency's crop mapping data.  
If the desired RDS already exists, the function informs the user.  
```{r}
flcounty <- function(countyname) {
#if nfhl does not exist in directory, download from fema
fldfiname <- "femadata/NFHL_06_20230220.zip"
if (!file.exists(fldfiname)){
dir.create("femadata")
download.file("https://hazards.fema.gov/nfhlv2/output/State/NFHL_06_20230220.zip",
destfile= fldfiname,mode = "wb")
}
#file <- unzip(fldfiname, exdir = "./femadata")
# take input county name as lower for string comparison
clname <- tolower(countyname)
# create name of rds to be created
fldrds <- paste0(clname,"flood.rds")
# if rds for nfhl county does not already exist in directory, create and save
#checks is county is in california before cropping, also checks for duplicates
if (!file.exists(fldrds)) {
usa= geodata::gadm("USA", level=2, path=".")
usa = usa[usa$NAME_1=="California"]
county_idx <- grep(paste0(clname, collapse="|"), tolower(usa$NAME_2))
# stops is county is not in california
if (length(county_idx) == 0) {
stop(paste(countyname, "county not found in California"))
} else if (length(county_idx) > 1) {
warning(paste("Multiple matches found for county", countyname))
}
# subsets to county
county <- usa[county_idx, ]
# creating spat vector from nfhl layer
 floodfiles <-unzip("./femadata/NFHL_06_20230220.zip",exdir="./femadata")
floodarea <- terra::vect("./femadata/NFHL_06_20230220.gdb",layer = "S_FLD_HAZ_AR")
 
#cropping to county and saving to rds
floodcounty = terra::crop(floodarea, county)
saveRDS(floodcounty, fldrds)
print(paste0(fldrds, " saved to directory"))
}else{print(paste0(fldrds, " already exists in directory"))}

# if land use data does not exist in directory, download from CNRA
landname <- "./landdata/i15_Crop_Mapping_2019.zip"
if (!file.exists(landname)){
dir.create("landdata")
url2<- "https://data.cnra.ca.gov/dataset/6c3d65e3-35bb-49e1-a51e-49d5a2cf09a9/resource/1da7b37a-dd97-4b69-a86a-fe824a252eaf/download/i15_crop_mapping_2019.zip"
download.file(url2,destfile= landname,mode = "wb")
#unzip("./landdata/i15_Crop_Mapping_2019.zip")
#landuse <- vect(usefiles[7])
} 
# create name of rds to be created
lu_rds <- paste0(clname,"landu.rds")
#if the rds for landuse does not exist for county, crops to county and saves
if (!file.exists(lu_rds)) {
usa= geodata::gadm("USA", level=2, path=".")
usa = usa[usa$NAME_1=="California"]
county_idx <- grep(paste0(clname, collapse="|"), tolower(usa$NAME_2))
# stops if county is not in california
if (length(county_idx) == 0) {
stop(paste(countyname, "county not found in California"))
} else if (length(county_idx) > 1) {
warning(paste("Multiple matches found for county", countyname))
}
# subsets to county
county <- usa[county_idx, ]
usefiles <-unzip("./landdata/i15_Crop_Mapping_2019.zip", exdir= "./landdata")
landuse <- terra::vect(paste0("./landdata/i15_Crop_Mapping_2019/i15_Crop_Mapping_2019.shp"))
lu_county = terra::crop(landuse, county)
saveRDS(lu_county, lu_rds)
print(paste0(lu_rds, " saved to directory"))
}else{print(paste0(lu_rds, " already exists in directory"))}
 
 }


```
Using the created function, we subset data for yolo county and sacramento county.  
Note that the function saves each landuse file in the format countynamelu.rds and each flood layer file as countynameflood.rds. The countyname here is the name of the specified county in all lowercase letters. Again, the function itself is case insensitive.  
```{r}
flcounty('yolo')
floodyolo <- readRDS("./yoloflood.rds")
yololu <- readRDS("./yololandu.rds")
yololu$COUNTY <- "Yolo"

flcounty('sacramento')
floodsac <- readRDS("./sacramentoflood.rds")
saclu <- readRDS("./sacramentolandu.rds")
saclu$COUNTY <- "Sacramento"
```
Then, we combine the data using rbind() and plot the flood areas in each county.
```{r}
landuse <- rbind(yololu,saclu) 
floodarea<- rbind(floodyolo,floodsac)
plot(landuse, main = "Flood Hazard areas in Sacramento and Yolo County",
     xlim = c(-122.3,-121),
    axes = FALSE)#box = TRUE)
lines(floodarea, col = "dodgerblue")

# add the legend to the plot
legend("bottomleft", col = c("dodgerblue"), legend = "flood zones", pch = 16)

```

organizing data into urban and agricultural land
```{r}

#landuse$agriculture <- landuse$SYMB_CLASS != "U"

# assign agriculture area if the value is not equal to U 
agind <- landuse$SYMB_CLASS != "U" 
#urbanind<- grep(uses,cats[11],value = 0)
# replacing the values in the column
landuse$landuse <- "urban"
landuse$landuse[agind]<- "agriculture"


highcats <- c("A","AE","AH","AO")
wavecats <- c("VE","V")
modcats <- c("X")
lowcats <- c("D","A99")
floodarea <- floodarea[floodarea$FLD_ZONE != "AREA NOT INCLUDED", ]
floodarea$zones <- "wrong"
floodarea$zones[floodarea$FLD_ZONE %in% highcats] <- "high risk"
floodarea$zones[floodarea$FLD_ZONE %in% modcats] <- "moderate risk"
floodarea$zones[floodarea$FLD_ZONE %in% wavecats] <- "high risk-wave action"
floodarea$zones[floodarea$FLD_ZONE %in% lowcats] <- "low risk"
#table(floodarea$zones, floodarea$FLD_ZONE)


luflood <- intersect(landuse, floodarea)

urbanf <- luflood[luflood$landuse == "urban"]
plot(landuse[landuse$landuse == "urban"],
     main = "Flood Zones in Urban Land in Yolo and Sacramento County",
     axes = FALSE, box = TRUE)
lines(urbanf, col = "dodgerblue")

agf <- luflood[luflood$landuse == "agriculture"]
plot(landuse[landuse$landuse == "agriculture"],
     main = "Flood Zones in Agricultural Land in Yolo and Sacramento County",
     axes = FALSE)#, box = TRUE)

lines(agf, col = "dodgerblue")

intdf <-data.frame(luflood$COUNTY,luflood$zones, luflood$landuse)

names(intdf)<- c("county","flood.risk","land.use")
# ggplot(data = heh,aes(x = county,y=lu,fill=risk))+
#   geom_bar(position = "stack",stat = "identity")
pal <- wes_palette("Moonrise3",3,type = "discrete")
x <- table(intdf$flood.risk)
par(mar = c(4,4,5,4))
barplot(x,main = "Overall Count of Each Flood Risk\n Type in Yolo and Sacramento County",
        col=pal[2] )
ggplot(data = intdf,                       
       aes(x = land.use,
           y = flood.risk,
           fill = flood.risk)) + 
  geom_bar(stat = "identity",
           position = "stack") +
  facet_grid(~ county)+ scale_fill_manual(values = pal)+
  labs(title = "Distribution of Flood Risk in Yolo and Sacramento County\nAcross Urban and Agricultural Land",
       x = "land use type", y = "frequency of flood risk category", fill = "flood risk type")+ 
  theme(axis.text.y = element_blank())
```
Calculating the proportion of flood-prone land  
```{r}

agarea <- sum(expanse(landuse[landuse$landuse=="agriculture"],unit = "km"))
frag <- sum(expanse(luflood[luflood$landuse=="agriculture"],unit = "km"))/agarea

urbarea<- sum(expanse(landuse[landuse$landuse=="urban"],unit = "km"))
frurb <- sum(expanse(luflood[luflood$landuse=="urban"],unit = "km"))/urbarea
```
Calculating proportion of each type of flood risk
```{r}
zonecats <- unique(luflood$zones)
agzonal = data.frame(zonecats,rep(1,length(zonecats)))
names(agzonal) <- c("risk","area")
for (i in 1:length(zonecats)){
  agzonal$area[i] = sum(expanse(luflood[luflood$landuse=="agriculture" & luflood$zones == zonecats[i]],
                     unit = "km"))
}
```
urban

```{r}
urbzonal = data.frame(zonecats,rep(1,length(zonecats)))
names(urbzonal) <- c("risk","area")
for (i in 1:length(zonecats)){
  agzonal$area[i] = sum(expanse(luflood[luflood$landuse=="urban" & luflood$zones == zonecats[i]],
                     unit = "km"))
}


```
writing data to shapefile for further visualization in arcgis pro
```{r}
# luflood <- aggregate(luflood,by = "zones",dissolve = TRUE)
# landuse <- aggregate(landuse, by = "landuse",dissolve = TRUE)
newfi <- "./processeddata/luflood.shp"
if (!file.exists(newfi)){
  dir.create("./processeddata")
writeVector(luflood,newfi)
writeVector(landuse,"./processeddata/croppedlanduse.shp")}
```

